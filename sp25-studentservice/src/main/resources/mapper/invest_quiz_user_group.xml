<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="invest_quiz_user_group">


    <sql id="sql_where">
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
        <if test="null!=GroupTitle  and ''!= GroupTitle">
            and a.GroupTitle = #{GroupTitle}
        </if>
        <if test="null!=CreateUserID  and ''!= CreateUserID">
            and a.CreateUserID = #{CreateUserID}
        </if>
        <if test="null!=quizID  and ''!= quizID">
            and a.quizID = #{quizID}
        </if>
        <if test="null!=privateInfo  and ''!= privateInfo">
            and a.privateInfo = #{privateInfo}
        </if>
    </sql>

    <!-- 删除 -->
    <delete id="deleteInfo" parameterType="map">
        UPDATE invest_quiz_user_group set is_delete = 'Y' WHERE id = #{id}
    </delete>


    <!-- 查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT a.*
        FROM invest_quiz_user_group a
        WHERE 1=1 and a.is_delete = 'N'
        <include refid="sql_where"/>
        limit 0,1
    </select>


    <select id="queryAutoUser" resultType="dto">
        SELECT a.* from invest_quiz_user_group a
        WHERE a.is_delete = 'N'
        order by a.id desc
    </select>


    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT
        a.*
        FROM
        invest_quiz_user_group a
        WHERE 1=1 and a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER BY a.id desc
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>


    <!-- 查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT
        count(a.id) as total
        FROM invest_quiz_user_group a
        WHERE 1=1 and a.is_delete = 'N'
        <include refid="sql_where"/>
    </select>

    <select id="queryCreateNotUser" parameterType="map" resultType="dto">

SELECT a.id,a.GroupTitle,a.privateInfo,a.quizID,IFNULL(d.exsitGroupCount,0) as exsitGroupCount FROM invest_quiz_user_group a
left join (
SELECT groupid,count(1) as exsitGroupCount from invest_quiz_user where groupid>0 and investUserID=#{CreateUserID} and quizID=#{quizID}  group by  groupid) d
on d.groupid=a.id
WHERE a.quizID=#{quizID}
 limit 0,1
      </select>


    <select id="queryUserJoinGroup" parameterType="map" resultType="dto">
select b.JoinCount,c.*  from  (SELECT a.groupID,count(a.groupID) as JoinCount from invest_quiz_user a where a.groupID>0 and a.investUserID=#{UserID}  group by a.groupID)b
left join invest_quiz_user_group c
on b.groupID=c.id
ORDER BY c.id
    </select>


    <select id="queryCountUserJoinGroup" parameterType="map" resultType="dto">
select count(b.JoinCount)  as total  from  (SELECT a.groupID,count(a.groupID) as JoinCount from invest_quiz_user a where a.groupID>0 and a.investUserID=#{UserID}  group by a.groupID)b
left join invest_quiz_user_group c
on b.groupID=c.id
ORDER BY c.id
    </select>

    <!-- 插入 -->
    <insert id="saveInfo" parameterType="dto">
        INSERT INTO invest_quiz_user_group
        (
        <if test="GroupTitle!=null and ''!=GroupTitle">
            GroupTitle,
        </if>
        <if test="CreateUserID!=null and ''!=CreateUserID">
            CreateUserID,
        </if>
        <if test="quizID!=null and ''!=quizID">
            quizID,
        </if>
        <if test="privateInfo!=null and ''!=privateInfo">
            privateInfo,
        </if>

        <if test="creator!=null and ''!=creator">
            creator,
        </if>
        create_time,
        is_delete
        )
        VALUES
        (
        <if test="GroupTitle!=null and ''!=GroupTitle">
            #{GroupTitle},
        </if>
        <if test="CreateUserID!=null and ''!=CreateUserID">
            #{CreateUserID},
        </if>
        <if test="quizID!=null and ''!=quizID">
            #{quizID},
        </if>
        <if test="privateInfo!=null and ''!=privateInfo">
            #{privateInfo},
        </if>

        <if test="creator!=null and ''!=creator">
            #{creator},
        </if>

        now(),
        'N')
        <selectKey resultType="java.lang.Long" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>


    </insert>


    <!-- 修改 -->
    <update id="updateInfo" parameterType="dto">
        update invest_quiz_user_group
        set
        <if test="null!=GroupTitle  and ''!= GroupTitle">
            GroupTitle = #{GroupTitle},
        </if>
        <if test="null!=CreateUserID  and ''!= CreateUserID">
            CreateUserID = #{CreateUserID},
        </if>
        <if test="null!=quizID  and ''!= quizID">
            quizID = #{quizID},
        </if>
        <if test="null!=privateInfo  and ''!= privateInfo">
            privateInfo = #{privateInfo},
        </if>
        <if test="null!=creator  and ''!= creator">
            creator = #{creator},
        </if>


        update_time = now()
        <if test="null!=updator  and ''!= updator">
         ,updator = #{updator}
        </if>
        where id = #{id}
    </update>


</mapper>
